trigger:
  branches:
    include:
      - main

pool:
  vmImage: 'ubuntu-latest'

variables:
  DB_USER: $(dbUser)
  DB_PASSWORD: $(dbPassword)
# Configure variables and stages
stages:
# =========================
# 0️⃣ Testes (executa mvn test usando um serviço PostgreSQL)
# =========================
- stage: Test
  displayName: 'Run Tests'
  jobs:
    - job: TestJob
      displayName: 'Run Maven Tests'
      pool:
        vmImage: 'ubuntu-latest'
      services:
        postgres:
          image: postgres:14
          env:
            POSTGRES_USER: postgres
            POSTGRES_PASSWORD: postgres
            POSTGRES_DB: ibike
          ports: ['5432:5432']
          options: >-
            --health-cmd "pg_isready -U postgres" --health-interval 10s --health-timeout 5s --health-retries 5
      steps:
        - script: |
            echo "Aguardando PostgreSQL inicializar..."
            # simples espera para o container ficar pronto
            sleep 15
            export DB_HOST=postgres
            export DB_NAME=ibike
            export DB_USER=postgres
            export DB_PASSWORD=postgres
            echo "Executando testes Maven (mvn -B test)"
            mvn -B test
          displayName: 'Run mvn test'

# =========================
# 1️⃣ Build Maven e Publicar Artefato
# =========================
- stage: Build
  displayName: 'Build & Publish Artifact'
  dependsOn: Test
  jobs:
    - job: BuildJob
      displayName: 'Build Maven Project'
      steps:
        # Build Maven (skip tests)
        - task: Maven@3
          inputs:
            mavenPomFile: 'pom.xml'
            goals: 'clean package -DskipTests'
          displayName: 'Build Maven Project (Skip Tests)'

        # Publicar JAR
        - task: PublishBuildArtifacts@1
          inputs:
            pathToPublish: 'target/ibike.jar'
            artifactName: 'iBikeApp'
          displayName: 'Publish Build Artifact'

# =========================
# 2️⃣ Docker Build & Push
# =========================
- stage: DockerBuildPush
  displayName: 'Docker Build & Push to ACR'
  dependsOn: Build
  jobs:
    - job: DockerJob
      displayName: 'Build Docker and Push to ACR'
      steps:
        - task: AzureCLI@2
          displayName: 'Build Docker Image and Push to ACR'
          inputs:
            azureSubscription: 'Azure Connection'   # Sua Service Connection
            scriptType: 'bash'
            scriptLocation: 'inlineScript'
            inlineScript: |
              chmod +x scripts/build.sh
              ./scripts/build.sh

# =========================
# 3️⃣ Deploy no Azure Container Instance
# =========================
- stage: DeployACI
  displayName: 'Deploy Application to ACI'
  dependsOn: DockerBuildPush
  jobs:
    - job: DeployJob
      displayName: 'Deploy to ACI'
      steps:
        - task: AzureCLI@2
          displayName: 'Deploy to ACI via deploy.sh'
          inputs:
            azureSubscription: 'Azure Connection'
            scriptType: 'bash'
            scriptLocation: 'inlineScript'
            inlineScript: |
              chmod +x scripts/deploy.sh
              ./scripts/deploy.sh
