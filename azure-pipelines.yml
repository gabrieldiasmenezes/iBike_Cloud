trigger:
  branches:
    include:
      - main

pool:
  vmImage: 'ubuntu-latest'

variables:
  DB_USER: $(dbUser)
  DB_PASSWORD: $(dbPassword)

stages:
# =========================
# 1️⃣ Build Maven e Publicar Artefato
# =========================
- stage: Build
  jobs:
    - job: BuildJob
      steps:
        - task: Maven@3
          inputs:
            mavenPomFile: 'pom.xml'
            goals: 'clean package -DskipTests'
          displayName: 'Build Maven Project (Skip Tests)'

        - task: PublishBuildArtifacts@1
          inputs:
            pathToPublish: 'target/ibike.jar'
            artifactName: 'iBikeApp'
          displayName: 'Publish Build Artifact'

# =========================
# 2️⃣ Docker Build & Push
# =========================
- stage: DockerBuildPush
  dependsOn: Build
  jobs:
    - job: DockerJob
      steps:
        - script: |
            chmod +x scripts/build.sh
            ./scripts/build.sh
          displayName: 'Build Docker Image and Push to ACR'

# =========================
# 3️⃣ Deploy no ACI
# =========================
- stage: DeployACI
  dependsOn: DockerBuildPush
  jobs:
    - job: DeployJob
      steps:
        - script: |
            chmod +x scripts/deploy.sh
            ./scripts/deploy.sh
          displayName: 'Deploy to ACI'
